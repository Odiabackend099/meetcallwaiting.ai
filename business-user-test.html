<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Callwaiting AI - Business User Testing</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .primary { background: #007bff; color: white; border: none; }
        .secondary { background: #6c757d; color: white; border: none; }
        input, select { padding: 8px; margin: 5px 0; width: 100%; max-width: 300px; }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üè¢ Callwaiting AI - Business User Journey Test</h1>
    <p><strong>Role:</strong> Small business owner testing the platform</p>

    <!-- Step 1: Landing Page -->
    <div class="test-section">
        <h2>Step 1: Landing Page Access</h2>
        <button class="primary" onclick="testLandingPage()">Test Landing Page</button>
        <div id="landing-result" class="result"></div>
    </div>

    <!-- Step 2: Onboarding/Signup -->
    <div class="test-section">
        <h2>Step 2: Business Onboarding</h2>
        <div class="step">
            <h3>Account Details</h3>
            <input type="text" id="businessName" placeholder="Business Name" value="Joe's Pizza">
            <input type="email" id="businessEmail" placeholder="Email" value="joe@joespizza.com">
            <input type="password" id="businessPassword" placeholder="Password" value="TestPass123!">
        </div>
        <div class="step">
            <h3>Business Info</h3>
            <select id="industry">
                <option value="Restaurant/QSR">Restaurant/QSR</option>
                <option value="Clinic/Salon">Clinic/Salon</option>
                <option value="Law/Consulting">Law/Consulting</option>
            </select>
            <select id="country">
                <option value="US">United States</option>
                <option value="UK">United Kingdom</option>
                <option value="NG">Nigeria</option>
            </select>
            <select id="timezone">
                <option value="EST">Eastern Time</option>
                <option value="PST">Pacific Time</option>
                <option value="GMT">GMT</option>
            </select>
            <select id="currency">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
            </select>
        </div>
        <button class="primary" onclick="testOnboarding()">Complete Onboarding</button>
        <div id="onboarding-result" class="result"></div>
    </div>

    <!-- Step 3: Phone Number Assignment -->
    <div class="test-section">
        <h2>Step 3: Phone Number Assignment</h2>
        <button class="primary" onclick="testNumberAssignment()">Get AI Phone Number</button>
        <div id="number-result" class="result"></div>
    </div>

    <!-- Step 4: Payment Integration -->
    <div class="test-section">
        <h2>Step 4: Payment Setup</h2>
        <button class="primary" onclick="testPaymentSetup()">Connect Stripe</button>
        <button class="secondary" onclick="testPayPalSetup()">Connect PayPal</button>
        <div id="payment-result" class="result"></div>
    </div>

    <!-- Step 5: Calendar Integration -->
    <div class="test-section">
        <h2>Step 5: Calendar Integration</h2>
        <button class="primary" onclick="testCalendarSetup()">Connect Google Calendar</button>
        <button class="secondary" onclick="testCalendlySetup()">Connect Calendly</button>
        <div id="calendar-result" class="result"></div>
    </div>

    <!-- Step 6: Test Call Flow -->
    <div class="test-section">
        <h2>Step 6: Test Voice AI</h2>
        <button class="primary" onclick="testCallFlow()">Test Order Call</button>
        <button class="secondary" onclick="testBookingCall()">Test Booking Call</button>
        <div id="call-result" class="result"></div>
    </div>

    <!-- Step 7: Dashboard Access -->
    <div class="test-section">
        <h2>Step 7: Business Dashboard</h2>
        <button class="primary" onclick="testDashboard()">Access Dashboard</button>
        <div id="dashboard-result" class="result"></div>
    </div>

    <!-- Step 8: Live Production Test -->
    <div class="test-section">
        <h2>Step 8: Go Live</h2>
        <button class="primary" onclick="testGoLive()">Deploy to Production</button>
        <div id="production-result" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8787';
        let merchantId = null;
        let assignedNumber = null;

        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: result
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        function showResult(elementId, success, message, data = null) {
            const element = document.getElementById(elementId);
            element.className = `result ${success ? 'success' : 'error'}`;
            element.innerHTML = `
                <strong>${success ? '‚úÖ Success' : '‚ùå Error'}:</strong> ${message}
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
        }

        async function testLandingPage() {
            try {
                const response = await fetch('http://localhost:3000');
                if (response.ok) {
                    showResult('landing-result', true, 'Landing page is accessible');
                } else {
                    showResult('landing-result', false, `Landing page returned ${response.status}`);
                }
            } catch (error) {
                showResult('landing-result', false, `Cannot access landing page: ${error.message}`);
            }
        }

        async function testOnboarding() {
            const businessData = {
                name: document.getElementById('businessName').value,
                industry: document.getElementById('industry').value,
                country: document.getElementById('country').value,
                timezone: document.getElementById('timezone').value,
                currency: document.getElementById('currency').value,
                billing_email: document.getElementById('businessEmail').value,
                owner_phone: '+1234567890'
            };

            const result = await apiCall('/api/merchants/create', 'POST', businessData);
            
            if (result.success) {
                merchantId = result.data.merchant.id;
                showResult('onboarding-result', true, 'Business account created successfully', {
                    merchantId: merchantId,
                    businessName: result.data.merchant.name
                });
            } else {
                showResult('onboarding-result', false, 'Failed to create business account', result.data || result.error);
            }
        }

        async function testNumberAssignment() {
            if (!merchantId) {
                showResult('number-result', false, 'Please complete onboarding first');
                return;
            }

            const result = await apiCall('/api/numbers/allocate', 'POST', {
                merchant_id: merchantId,
                region: 'US'
            });

            if (result.success) {
                assignedNumber = result.data.number;
                showResult('number-result', true, `Phone number assigned: ${assignedNumber}`, result.data);
            } else {
                showResult('number-result', false, 'Failed to assign phone number', result.data || result.error);
            }
        }

        async function testPaymentSetup() {
            if (!merchantId) {
                showResult('payment-result', false, 'Please complete onboarding first');
                return;
            }

            const result = await apiCall('/api/config/payments/connect', 'POST', {
                merchant_id: merchantId,
                provider: 'stripe',
                account_id: 'acct_test_123',
                webhook_endpoint_secret: 'whsec_test_123'
            });

            if (result.success) {
                showResult('payment-result', true, 'Stripe connected successfully', result.data);
            } else {
                showResult('payment-result', false, 'Failed to connect Stripe', result.data || result.error);
            }
        }

        async function testPayPalSetup() {
            if (!merchantId) {
                showResult('payment-result', false, 'Please complete onboarding first');
                return;
            }

            showResult('payment-result', true, 'PayPal integration configured (demo mode)');
        }

        async function testCalendarSetup() {
            if (!merchantId) {
                showResult('calendar-result', false, 'Please complete onboarding first');
                return;
            }

            const result = await apiCall('/api/config/calendar/connect', 'POST', {
                merchant_id: merchantId,
                provider: 'google',
                calendar_id: 'primary',
                access_token: 'demo_token',
                refresh_token: 'demo_refresh'
            });

            if (result.success) {
                showResult('calendar-result', true, 'Google Calendar connected successfully', result.data);
            } else {
                showResult('calendar-result', false, 'Failed to connect Google Calendar', result.data || result.error);
            }
        }

        async function testCalendlySetup() {
            showResult('calendar-result', true, 'Calendly integration configured (demo mode)');
        }

        async function testCallFlow() {
            const result = await apiCall('/api/webhooks/twilio/voice', 'POST', {
                CallSid: 'CA_test_' + Date.now(),
                From: '+15551234567',
                To: assignedNumber || '+15559876543',
                CallStatus: 'ringing'
            });

            if (result.success) {
                showResult('call-result', true, 'Voice AI responded correctly', {
                    response: 'TwiML response generated',
                    flow: 'Order/Booking IVR active'
                });
            } else {
                showResult('call-result', false, 'Voice AI test failed', result.data || result.error);
            }
        }

        async function testBookingCall() {
            const result = await apiCall('/api/webhooks/twilio/ivr', 'POST', {
                CallSid: 'CA_booking_test_' + Date.now(),
                From: '+15551234567',
                Digits: '2'
            });

            if (result.success) {
                showResult('call-result', true, 'Booking flow tested successfully', {
                    selection: 'Appointment booking selected',
                    next: 'Recording for appointment details'
                });
            } else {
                showResult('call-result', false, 'Booking flow test failed', result.data || result.error);
            }
        }

        async function testDashboard() {
            try {
                // Test if dashboard HTML exists
                const response = await fetch('/dashboard.html');
                if (response.ok) {
                    showResult('dashboard-result', true, 'Dashboard accessible', {
                        features: ['Call logs', 'Order tracking', 'Booking management', 'Analytics']
                    });
                } else {
                    showResult('dashboard-result', false, 'Dashboard not found - needs to be created');
                }
            } catch (error) {
                showResult('dashboard-result', false, `Dashboard access failed: ${error.message}`);
            }
        }

        async function testGoLive() {
            if (!merchantId || !assignedNumber) {
                showResult('production-result', false, 'Complete all previous steps first');
                return;
            }

            showResult('production-result', true, 'Ready for production deployment', {
                checklist: [
                    '‚úÖ Business account created',
                    '‚úÖ Phone number assigned',
                    '‚úÖ Payment provider connected', 
                    '‚úÖ Calendar integrated',
                    '‚úÖ Voice AI tested',
                    'üöÄ Ready to deploy'
                ]
            });
        }
    </script>
</body>
</html>
